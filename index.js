!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=8)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StringUtils={},e.StringUtils.NEWLINE="\n";var o=function(){return function(t,e,n){this.success=t,this.result=e,this.line=n}}();e.ExtractResult=o,e.StringUtils.getBefore=function(t,e){var n=t.indexOf(e);return n>-1?t.slice(0,n):t},e.StringUtils.startsWith=function(t,e){return t.indexOf(e)>-1},e.StringUtils.endsWith=function(t,e){return-1!==t.indexOf(e,t.length-e.length)},e.StringUtils.isSpace=function(t){return" "==t||"\t"==t||"\f"==t},e.StringUtils.isWhiteSpace=function(t){return" "==t||"\t"==t||"\n"==t||"\f"==t||"\r"==t},e.StringUtils.innerText=function(t,e,n,o){void 0===o&&(o=0);var r=t.indexOf(e,o);if(-1==r)return"";var i=r+e.length,a=t.indexOf(n,i);return a>-1?t.substring(i,a):t.substring(i)},e.StringUtils.extractInnerText=function(t,n,r){var i=e.StringUtils.innerText(t,n,r),a=i.length>0,s=t;return a&&(s=t.replace(n+i+r,"")),new o(a,i,s)},e.StringUtils.outerText=function(t,n,o){var r=e.StringUtils.innerText(t,n,o);return r.length>0?n+r+o:""},e.StringUtils.innerTexts=function(t,e,n){for(var o=[],r=e.length,i=n.length,a=0,s=0;;){if(-1==(a=t.indexOf(e,a)))break;if(a+=r,-1==(s=t.indexOf(n,a)))break;o.push(t.substring(a,s)),a=s+i}return o},e.StringUtils.substringBeforeAnyFromSet=function(t,e){for(var n=0;n<t.length;n++)if(e.indexOf(t[n])>-1)return t.substr(0,n);return""},e.StringUtils.substringBeforeAnyFromArray=function(t,e){for(var n=-1,o=0;o<e.length;o++)if((n=t.indexOf(e[o]))>-1)return t.substr(0,n);return""};var r=[{char:"&",spec:"&amp;"},{char:"<",spec:"&lt;"},{char:">",spec:"&gt;"},{char:'"',spec:"&quot;"},{char:"'",spec:"&#039;"}];e.StringUtils.decodeHtmlSpecialChars=function(t){return r.forEach(function(e){t=t.replace(e.spec,e.char)}),t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){var n=this;this.transistor=e,this.screens={},t.forEach(function(t){t.setRouter(n),n.screens[t.id]=t})}return t.prototype.goScreen=function(t,e){var n=this;this.next=this.screens[t],this.current&&this.current.onStop(),this.next.onCreate(),this.transistor.makeTransition(this.current,this.next,function(){n.current&&n.current.onDestroy(),n.current=n.next,n.next.onStart()},e)},t}();e.AppDefault=o;var r=function(){function t(){}return t.prototype.makeTransition=function(t,e,n,o){t&&t.getContext(),e.getContext();n()},t}();e.TransistorDefault=r;var i=function(){function t(t,e,n){this.id=t,this.view=e,this.controller=n}return t.prototype.goScreen=function(t,e){this.router.goScreen(t,e)},t.prototype.onCreate=function(){console.log(this.id+" ScreenDefault onCreate"),this.view.create()},t.prototype.onDestroy=function(){console.log(this.id+" ScreenDefault onDestroy"),this.view.destroy()},t.prototype.onStart=function(){console.log(this.id+" ScreenDefault onStart"),this.controller.bind(this.view.getContext())},t.prototype.onStop=function(){console.log(this.id+" ScreenDefault onStop"),this.controller.unbind(this.view.getContext())},t.prototype.getContext=function(){return this.view.getContext()},t.prototype.setRouter=function(t){this.router=t},t}();e.ScreenDefault=i;var a=function(){function t(){}return t.prototype.create=function(){console.log("ViewDefault create")},t.prototype.destroy=function(){console.log("ViewDefault destroy")},t.prototype.getContext=function(){},t}();e.ViewDefault=a;var s=function(){function t(){}return t.prototype.bind=function(t){this.context=t,console.log("ControllerDefault bind")},t.prototype.unbind=function(t){console.log("ControllerDefault unbind")},t}();e.ControllerDefault=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DomUtils={},e.DomUtils.removeId=function(t){t.removeAttribute("id")},e.DomUtils.displayNone=function(t){t.style.display="none"},e.DomUtils.display=function(t){t.style.display=""},e.DomUtils.attrs=function(t,e){for(var n in e)t.setAttribute(n,e[n])},e.DomUtils.element=function(t,e){var n=document.createElement(t);return this.attrs(n,e),n},e.DomUtils.css=function(t){return this.element("link",{rel:"stylesheet",type:"text/css",href:t})},e.DomUtils.js=function(t){return this.element("script",{type:"text/javascript",src:t})},e.DomUtils.addToHead=function(t){return document.getElementsByTagName("head")[0].appendChild(t),t},e.DomUtils.addCss=function(t){return this.addToHead(this.css(t))},e.DomUtils.addJs=function(t){return this.addToHead(this.js(t))},e.DomUtils.clearEls=function(t){if(null==t||0==t.length)return t;for(var e,n=t.length-1;n>-1;n--)(e=t[n]).parentElement&&e.parentElement.removeChild(e),t.pop();return t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.NodeSpecialNames={start:"start"};var o=function(){return function(t,e,n,o,r,i){void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=""),void 0===o&&(o=""),void 0===r&&(r=null),void 0===i&&(i=[]),this.id=t,this.title=e,this.text=n,this.style=o,this.hub=r,this.choices=i}}();e.GameNode=o;var r=function(){return function(t,e,n,o,r){void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=!1),void 0===o&&(o=null),void 0===r&&(r=null),this.toNodeId=t,this.text=e,this.oneWay=n,this.condition=o,this.paramOp=r,this.id=-1,0==this.text.length&&(this.text=this.toNodeId)}}();e.Choice=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(1),r=n(9),i=n(15),a=n(16),s=n(23),c=n(2),l=n(24),u=n(27),h=n(3);e.SCREENS={boot:"boot",game:"game"};var p=window.GameConfig;function d(){var t=[];p.src&&t.push({id:p.src,src:p.src}),p.html&&t.push({id:p.html,src:p.html});var n=window.GameSourceFormat;console.log("EXTERNAL_FORMAT",n);var c=window.GameFunc;console.log("GAME_FUNC",c);var d=c||{},f=new l.Parser(u.FormatDefault,n,d,h.NodeSpecialNames),m=new i.AppContext("game",new s.FramePreloader,t,p,f),g=new o.TransistorDefault,v=[new r.BootScreen(e.SCREENS.boot,m),new a.GameScreen(e.SCREENS.game,m)];new o.AppDefault(v,g).goScreen(e.SCREENS.boot)}console.log("GAME_CONFIG!",p),e.main=function(){p.css&&c.DomUtils.addCss(p.css);var t=p.format?c.DomUtils.addJs(p.format):null,e=p.func?c.DomUtils.addJs(p.func):null;e?e.onload=d:t?t.onload=d:d()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){return function(){}}();e.ViewContext=o,e.addViewScreen=function(t){var e=document.createElement("div");return e.setAttribute("class","game-screen"),t.appendChild(e),e}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DataBindClasses={choice:"choice-input"}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o="from",r="to",i="choice";e.GameDataBinder={setChoice:function(t,e,n){n.dataset[o]=e.id,n.dataset[r]=t.toNodeId,n.dataset[i]=""+t.id},getChoiceId:function(t){return parseInt(t.dataset[i])},getChoiceTo:function(t){return t.dataset[r]},getChoiceFrom:function(t){return t.dataset[o]}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),n(4).main()},function(t,e,n){"use strict";var o,r=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=n(10),s=n(11),c=n(13),l=function(t){function e(e,n){var o=t.call(this,e,new s.BootView(n),new a.BootController)||this;return o.logic=new c.BootLogic,o.appContext=n,o}return r(e,t),e.prototype.onCreate=function(){console.log(this.id+" BootScreen onCreate"),this.view.create(),this.logic.onCreateView(this.view,this.appContext.assetSource,this.appContext.preloader,this.router)},e.prototype.onStart=function(){console.log(this.id+" BootScreen onStart"),this.controller.bind(this.view.getContext()),this.logic.onStartView()},e}(i.ScreenDefault);e.BootScreen=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(){}return t.prototype.bind=function(t){var e=this;this.clickListener=function(t){e.parentClick&&e.parentClick()},t.screenElement.addEventListener("click",this.clickListener)},t.prototype.unbind=function(t){t.screenElement.removeEventListener("click",this.clickListener)},t.prototype.onClick=function(t){return this.parentClick=t,this},t}();e.BootController=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(5),r=n(12),i=function(){function t(t){this.context=new o.ViewContext,this.context.id=t.gameId,this.context.parent=document.getElementById(t.gameId),this.preloaderImageUrl=t.gameConfig.preloader,console.log("BootView take id = "+t.gameId)}return t.prototype.create=function(){console.log("BootView create"),this.context.screenElement=o.addViewScreen(this.context.parent);this.svgEl=this.createSvgContainer(720,520),this.context.screenElement.innerHTML="",this.context.screenElement.appendChild(this.svgEl),this.preloaderImage=this.createPreloaderImage(this.preloaderImageUrl),this.svgEl.appendChild(this.preloaderImage)},t.prototype.destroy=function(){console.log("BootView destroy"),this.context.screenElement.innerHTML="",this.context.parent.removeChild(this.context.screenElement)},t.prototype.getContext=function(){return this.context},t.prototype.showProgress=function(t){var e="loading: "+t+" %";console.log(""+e)},t.prototype.addResult=function(t){this.context.screenElement.appendChild(t)},t.prototype.createSvgContainer=function(t,e){return void 0===t&&(t=720),void 0===e&&(e=520),r.SvgUtils.create("svg",{width:t+"px",height:e+"px"})},t.prototype.createPreloaderImage=function(t){return r.SvgUtils.create("image",{"xlink:href":t})},t}();e.BootView=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SvgUtils={},e.SvgUtils.create=function(t,n){var o=document.createElementNS("http://www.w3.org/2000/svg",t);return n&&e.SvgUtils.set(o,n),o},e.SvgUtils.set=function(t,e){for(var n in e)"xlink:href"==n||"src"==n?t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e[n]):t.setAttribute(n,e[n])}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(4),r=n(14),i=function(){function t(){}return t.prototype.onCreateView=function(t,e,n,o){this.view=t,this.assets=e,this.preloader=n,this.router=o},t.prototype.onStartView=function(){this.assets.length>0?this.preload():this.onLoadComplete()},t.prototype.onLoadComplete=function(){var t=this;console.log("BootScreen.onLoadComplete"),r.orderFunction(function(){t.router.goScreen(o.SCREENS.game)},100)},t.prototype.preload=function(){var t=this,e=this.view,n=this.preloader;n.onLoad(function(e){t.onLoadComplete()}),n.onFileLoad(function(t){console.log(t),console.log("fileload...")}),n.onError(function(t){console.log(t),console.log("error...")}),n.onProgress(function(t){console.log(t),e.showProgress(100*t.progress)}),n.load(this.assets)},t}();e.BootLogic=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.orderFunction=function(t,e){void 0===e&&(e=0),setTimeout(t,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){return function(t,e,n,o,r){this.gameId=t,this.preloader=e,this.assetSource=n,this.gameConfig=o,this.parser=r}}();e.AppContext=o},function(t,e,n){"use strict";var o,r=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=n(17),s=n(20),c=n(21),l=n(22),u=function(t){function e(e,n){var o=t.call(this,e,new a.GameView(n),new s.GameController)||this;return o.assetsCache=n.preloader.cache,o.gameEngine=new c.QuestEngine,o.gameRepo=new l.GameRepository,o.gameConfig=n.gameConfig,o.parser=n.parser,o}return r(e,t),e.prototype.onCreate=function(){console.log(this.id+" GameScreen onCreate"),this.gameDesign=this.assetsCache[this.gameConfig.html]||document.getElementById("design").innerHTML,null==this.gameData?this.startDataLoad():this.createView()},e.prototype.onStart=function(){var t=this;this.controller.bind(this.view.getContext()),this.controller.onChoiceClick(function(e,n,o){var r=t.gameEngine.getNode(o),i=t.gameEngine.makeChoice(e,n,o);t.view.showGameNode(t.gameData.state.params,i,r)})},e.prototype.startDataLoad=function(){this.gameData=this.parseGameSource(),this.gameRepo.load(this.onGameStateLoad.bind(this))},e.prototype.onGameStateLoad=function(t){if(t.success){var e=t.data;console.log("game state load success"),console.log(e),this.gameData.state=e}else console.log("game state load FAIL"),console.log("Result Message: "+t.message);this.gameEngine.setGame(this.gameData),this.createView()},e.prototype.parseGameSource=function(){var t=this.assetsCache[this.gameConfig.src];return this.parser.parse(t)},e.prototype.createView=function(){this.view.create(),this.view.setDesign(this.gameDesign),this.view.showGameNode(this.gameData.state.params,this.gameEngine.getStart())},e}(i.ScreenDefault);e.GameScreen=u},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(5),r=n(18),i=n(2),a=function(){function t(t){this.context=new o.ViewContext,this.context.id=t.gameId,this.gameConfig=t.gameConfig,this.context.parent=document.getElementById(t.gameId),this.viewHtml=new r.ViewHtml}return t.prototype.create=function(){console.log("GameView create"),this.context.screenElement=o.addViewScreen(this.context.parent),this.context.screenElement.innerHTML="GameView create"},t.prototype.destroy=function(){console.log("GameView destroy"),this.context.parent.removeChild(this.context.screenElement)},t.prototype.getContext=function(){return this.context},t.prototype.setDesign=function(t){this.viewHtml.setTemplate(t)},t.prototype.showGameNode=function(t,e,n){this.setNodeStyle(e.style),this.viewHtml.injectNode(t,e,n),this.context.screenElement.innerHTML=this.viewHtml.getHtml()},t.prototype.setNodeStyle=function(t){null!=t&&0!=t.length&&(this.setBodyId(t),this.attachCss(t))},t.prototype.setBodyId=function(t){document.body.id=t},t.prototype.attachCss=function(t){if(null!=this.gameConfig.styles&&null!=this.gameConfig.styles[t]){var e=this.gameConfig.styles[t];null==this.nodeStyleEl?this.nodeStyleEl=i.DomUtils.addCss(e):i.DomUtils.attrs(this.nodeStyleEl,{href:e})}},t}();e.GameView=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(2),r=n(0),i=n(6),a=n(7),s=n(19),c={choiceStart:"<choice>",choiceEnd:"</choice>",paramAutoStart:"<param-label>",paramAutoEnd:"</param-label>",paramNameStart:"<param-name>",paramNameEnd:"</param-name>",backlinkStart:"<backlink>",backlinkEnd:"</backlink>"},l={title:"@title",text:"@text",choice:"@choice",paramAutoLabel:"@paramLabel",paramAutoValue:"@paramValue",paramsAutoPlace:"@paramAuto",paramsNamedPlace:"@paramNamed",choicePlace:"@choices"},u=function(){function t(){this.code="",this.dataBinder=a.GameDataBinder}return t.prototype.setTemplate=function(t){var e,n,o=this,i=c,a=l;this.template=t,this.templateParamAuto=this.extractTemplate(i.paramAutoStart,i.paramAutoEnd,a.paramsAutoPlace),this.templateChoice=this.extractTemplate(i.choiceStart,i.choiceEnd,a.choicePlace),this.templateBacklink=this.extractTemplate(i.backlinkStart,i.backlinkEnd,""),this.templateParamNames=r.StringUtils.innerTexts(this.template,i.paramNameStart,i.paramNameEnd),this.templateParamNames.forEach(function(t,r){e=o.getParamNamedMark(t),n=o.getParamNamedTemplate(t),o.template=o.template.replace(n,e)})},t.prototype.getHtml=function(){return this.code},t.prototype.injectNode=function(t,e,n){var o=this.template;o=(o=o.replace(l.title,e.title)).replace(l.text,e.text),o=this.injectChoices(o,e,n),o=this.injectParams(o,t),this.code=o},t.prototype.injectParams=function(t,e){return t=this.injectParamsNamed(t,e)},t.prototype.extractTemplate=function(t,e,n){void 0===n&&(n="");var o=r.StringUtils.innerText(this.template,t,e);if(0==o.length)return o;var i=t+o+e;return this.template=this.template.replace(i,n),o},t.prototype.injectChoices=function(t,e,n){var o=this,r="";return e.choices.forEach(function(t){r+=o.makeChoiceCode(void 0,t,e,n)}),t=t.replace(l.choicePlace,r)},t.prototype.makeChoiceCode=function(t,e,n,r){var a=e.text;return r&&r.id==e.toNodeId&&(a=this.templateBacklink+e.text),t=this.templateChoice.replace(l.choice,a),null==this.choiceWrapperEl&&(this.choiceWrapperEl=o.DomUtils.element("div",{class:i.DataBindClasses.choice})),this.dataBinder.setChoice(e,n,this.choiceWrapperEl),this.choiceWrapperEl.innerHTML=t,t=this.choiceWrapperEl.outerHTML},t.prototype.injectParamsNamed=function(t,e){var n,o,r=this;return this.templateParamNames.forEach(function(i){n=r.getParamNamedMark(i),null==(o=s.ObjectUtils.getObjectField(i,e))&&(o=""),t=t.replace(n,o)}),t},t.prototype.getParamNamedMark=function(t){return l.paramsNamedPlace+t},t.prototype.getParamNamedTemplate=function(t){return c.paramNameStart+t+c.paramNameEnd},t}();e.ViewHtml=u},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ObjectUtils={},e.ObjectUtils.getObjectField=function(t,e){for(var n=(t=(t=t.replace(/\[(\w+)\]/g,".$1")).replace(/^\./,"")).split("."),o=0,r=n.length;o<r;++o){var i=n[o];if(!(i in e))return;e=e[i]}return e}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(6),r=n(7),i=function(){function t(){this.dataBinder=r.GameDataBinder}return t.prototype.bind=function(t){var e=this;this.clickListener=function(t){e.onGameClick(t)},t.screenElement.addEventListener("click",this.clickListener)},t.prototype.unbind=function(t){t.screenElement.removeEventListener("click",this.clickListener)},t.prototype.onChoiceClick=function(t){this.choiceCallback=t},t.prototype.onGameClick=function(t){var e,n=t.target,r=o.DataBindClasses.choice;return n.classList.contains(r)?e=n:n.parentElement.classList.contains(r)&&(e=n.parentElement),e&&this.choiceCallback&&this.choiceCallback(this.dataBinder.getChoiceId(e),this.dataBinder.getChoiceTo(e),this.dataBinder.getChoiceFrom(e)),!1},t}();e.GameController=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(3);e.DEFAULT_CONST={startId:"start",errorId:"error"};var r=function(){function t(){this.errorNode=new o.GameNode(e.DEFAULT_CONST.errorId,"Ошибка!"),this.constants=e.DEFAULT_CONST,this.virtualNode=new o.GameNode}return t.prototype.setGame=function(t){return this.gameState=t.state,null==this.gameState.nodes.current&&(this.gameState.nodes.current=this.constants.startId),this.hashMap=t.nodeMap,this},t.prototype.setConstants=function(t){return this.constants=t,this},t.prototype.getState=function(){return this.gameState},t.prototype.getViewNode=function(t){var e=this.getNode(t);return this.virtualNode.id=e.id,this.virtualNode.title=e.title,this.virtualNode.text=e.text,this.virtualNode.style=e.title,this.virtualNode.choices=e.choices.slice(0),this.countChoices(this.virtualNode),this.virtualNode.choices=this.virtualNode.choices.filter(function(t){return null==t.condition||t.condition()}),this.virtualNode},t.prototype.getStart=function(){return this.getViewNode(this.constants.startId)},t.prototype.makeChoice=function(t,e,n){var r;return console.log("makeChoice!"),this.calcChoiceOperations(n,t,e),this.hasNode(e)?(this.gameState.nodes.prev=n,this.gameState.nodes.current=e,r=this.getViewNode(e)):r=this.formatError(e+" не найден",new o.Choice(n,"Вернуться")),r},t.prototype.calcChoiceOperations=function(t,n,o){if(t!=e.DEFAULT_CONST.errorId){var r=this.hashMap[t].choices[n];console.log(r),console.log("idFrom = "+t+"  idChoice = "+o),r.paramOp&&r.paramOp()}},t.prototype.getNode=function(t){var e=this.hashMap[t];return console.log("--- get Node -----"),console.log(e),console.log("--- /get Node -----"),e},t.prototype.hasNode=function(t){return!(null==this.getNode(t))},t.prototype.formatError=function(t,e){return this.errorNode.text=t,this.errorNode.choices[0]=e,this.errorNode},t.prototype.countChoices=function(t){t.choices.forEach(function(t,e){return t.id=e})},t}();e.QuestEngine=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(){}return t.prototype.load=function(t){t({success:!1,message:"game repository not implemented",data:null})},t.prototype.save=function(t,e){},t}();e.GameRepository=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),r=function(){function t(){this.cache={}}return t.prototype.load=function(t){t&&t.length>0?this.startLoading(t):this.finishLoading()},t.prototype.onError=function(t){return this.onErrorCallback=t,this},t.prototype.onFileLoad=function(t){return this.onFileLoadCallback=t,this},t.prototype.onLoad=function(t){return this.onLoadCallback=t,this},t.prototype.onProgress=function(t){return this.onProgressCallback=t,this},t.prototype.attachFrame=function(t){var e=document.createElement("iframe");e.setAttribute("width","1"),e.setAttribute("height","1"),e.setAttribute("id",t.id),e.setAttribute("src",t.src),this.iframes.push(e),this.iframeParent.appendChild(e)},t.prototype.attachListener=function(){var t=this;this.hasListener=!0,this.listener=function(e){t.onMessageListener(e)},window.addEventListener?window.addEventListener("message",this.listener):console.log("FramePreloader error - нет window.addEventListener")},t.prototype.detachListener=function(){this.hasListener=!1,window.removeEventListener?window.removeEventListener("message",this.listener):console.log("FramePreloader error - нет window.removeEventListener")},t.prototype.onMessageListener=function(t){var e=this,n=t.data,o=this.getIdByUrl(n.url),r=n.content;this.cache[o]=r,this.onFileLoadCallback&&this.onFileLoadCallback(t),this.loadedAmount++;var i=this.loadedAmount/this.totalAmount;this.onProgressCallback&&this.onProgressCallback({progress:i}),this.loadedAmount==this.totalAmount&&(this.finishLoading(),this.onLoadCallback&&setTimeout(function(){e.onLoadCallback({progress:1,amount:e.totalAmount})},5))},t.prototype.startLoading=function(t){1!=this.hasListener&&this.attachListener(),this.totalAmount=t.length,this.loadedAmount=0,this.iframes=[],this.initAssets(t),this.attachAssetIframes(t)},t.prototype.initAssets=function(t){var e=this;this.assets=t,this.assetsWithUrlTails=[],this.assets.forEach(function(t){var n=e.getUrlTail(t.src);e.assetsWithUrlTails.push({id:t.id,src:n})})},t.prototype.attachAssetIframes=function(t){var e=this;this.iframeParent=document.documentElement,t.forEach(function(t){e.attachFrame(t)})},t.prototype.finishLoading=function(){var t=this;this.hasListener&&this.detachListener(),this.iframes&&this.iframes.forEach(function(e){return t.iframeParent.removeChild(e)})},t.prototype.getIdByUrl=function(t){for(var e,n=this.assetsWithUrlTails,r=n.length,i=0;i<r;i++)if(e=n[i],o.StringUtils.endsWith(t,e.src))return e.id;return""},t.prototype.getUrlTail=function(t){var e=t.lastIndexOf("./")+"./".length;return t.substr(e)},t}();e.FramePreloader=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(3),r=n(0),i=n(25),a=n(26),s=function(){return function(t,e){var n=t.indexOf(e.paramLabelStart);this.label="",n>-1&&(this.label=t.substr(n+e.paramLabelStart.length+1).trim(),t=t.substr(0,n).trim()),this.strWithoutLabel=t}}(),c=function(){function t(t,e,n,o){this.format=t,this.externalFormat=e,this.params=n,this.nodeSpecialNames=o,this.injectExternalFormat(e),this.paramUiLabelLength=this.format.paramLabelStart.length}return t.prototype.parse=function(t){var e,n={},o=this.format,r=this.parseLines(t);r=this.cleanLineComments(r);for(var a,s=this.params,c=[],l=!1,u=[],h=0;h<r.length;h++)a=r[h],l||!this.isParamLine(a)?(this.isNodeStart(a)&&(u.length>0&&(e=this.parseNode(u,s),c.push(e),n[e.id]=e,u=[]),a=a.replace(o.nodeStart,""),l=!0),u.push(a)):this.parseInitParamToHash(a,s);return l&&u.length>0&&(e=this.parseNode(u,s),c.push(e),n[e.id]=e,u=[]),this.normalizeMap(n,c),{state:new i.GameState(s),nodeMap:n}},t.prototype.cleanLineComments=function(t){return t.map(this.cleanComment,this).filter(function(t){return t.length>0})},t.prototype.normalizeMap=function(t,e){return t=this.makeStartNode(t,e),this.makeBackLinks(t,e),t},t.prototype.makeStartNode=function(t,e){return null==t[this.nodeSpecialNames.start]&&(t[this.nodeSpecialNames.start]=e[0]),t},t.prototype.makeBackLinks=function(t,e){var n=this;return e.forEach(function(e){null!=e.hub&&(0==e.hub.length&&(e.hub=e.title),e.choices.forEach(function(o){o.oneWay||(null!=t[o.toNodeId]?n.makeSingleBackLink(t,o.toNodeId,e.id,e.hub):console.log("Парсер бэклинкер не видит узел "+o.toNodeId))}))}),t},t.prototype.makeSingleBackLink=function(t,e,n,r){var i=t[e];if(!(i.choices.filter(function(t){return t.toNodeId==n}).length>0)){var a=new o.Choice(n,r);i.choices.push(a)}},t.prototype.parseNode=function(t,e){var n,i=this.format,a=0,s=(n=t[a]).split(i.nodeTitleStart),c=s[0],l=s[1]||c;a++;for(var u="",h=!0,p=null,d=!0,f="";a<t.length;a++)if(n=t[a],h&&r.StringUtils.startsWith(n,i.nodeStyleStart))u=n.replace(i.nodeStyleStart,"").trim(),h=!1;else if(d&&r.StringUtils.startsWith(n,i.nodeHubStart))p=n.replace(i.nodeHubStart,"").trim(),d=!1;else{if(r.StringUtils.startsWith(n,i.choiceStart))break;f+=n+"\n"}for(var m=[];a<t.length;a++)n=t[a],r.StringUtils.startsWith(n,i.choiceStart)&&m.push(this.parseChoice(n,e));return new o.GameNode(c.trim(),l.trim(),f.trim(),u,p,m)},t.prototype.parseLines=function(t){return t.split(r.StringUtils.NEWLINE)},t.prototype.cleanComment=function(t){return r.StringUtils.getBefore(t,this.format.commentStart).trim()},t.prototype.parseChoice=function(t,e){var n=this.format,i=(t=t.replace(n.choiceStart,"")).indexOf(n.choiceOneWayMarker)>-1;i&&(t=t.replace(n.choiceOneWayMarker,""));var s=null,c=this.extractIf(t);c.success&&(c.result="return "+r.StringUtils.decodeHtmlSpecialChars(c.result),c.result="console.log(this);"+c.result,console.log("ifResult.result = "+c.result),s=a.MAKE_FUNC(c.result,e),t=c.line);var l=t.split(n.choiceTitleStart),u=l[0].trim(),h=u,p=function(){};if(l.length>1){var d=l[1].split(n.paramStringStart);h=d[0].trim(),(d.length>1?d[1]:"").length>0&&(p=a.MAKE_FUNC(d[1],e,this.format.paramStartRegExp))}return new o.Choice(u,h,i,s,p)},t.prototype.isParamLine=function(t){return r.StringUtils.startsWith(t,this.format.paramStringStart)},t.prototype.splitParamsOpsToSingles=function(t){return t.split(this.format.paramStrOperationsDelim)},t.prototype.parseInitParamToHash=function(t,e){var n,o,r=this,i=this.format;t=t.replace(i.paramStringStart,""),this.splitParamsOpsToSingles(t).forEach(function(t){n=new s(t,r.format),o=n.strWithoutLabel,a.MAKE_FUNC(o,e,r.format.paramStartRegExp)()})},t.prototype.isNodeStart=function(t){return r.StringUtils.startsWith(t,this.format.nodeStart)},t.prototype.injectExternalFormat=function(t){var e=this;null!=t&&Object.keys(t).forEach(function(n){null!=t[n]&&"string"==typeof t[n]&&(e.format[n]=t[n])})},t.prototype.extractIf=function(t){return r.StringUtils.extractInnerText(t,this.format.ifStart,this.format.ifEnd)},t}();e.Parser=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=function(){return function(t){void 0===t&&(t={}),this.params=t,this.nodes={current:null,prev:null,history:[]}}}();e.GameState=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=n(0);function r(t,e){return void 0===e&&(e=/\$/gi),t.replace(e,"this.")}e.CALC=function(t){return new Function("return "+t)()},e.MAKE_FUNC=function(t,e,n){return e&&(t=r(t,n)),t=o.StringUtils.decodeHtmlSpecialChars(t),new Function(t).bind(e)},e.CALC_FOLD_BY_THIS=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.FormatDefault={nodeStart:"#",nodeTitleStart:":",nodeStyleStart:"@style",nodeHubStart:"@hub",commentStart:"//",choiceStart:"*",choiceTitleStart:":",choiceOneWayMarker:"@oneway",ifStart:"@if",ifEnd:"@end",paramStringStart:"@param",paramStartRegExp:/\$/gi,paramLabelStart:":",paramOperations:{plus:"+",minus:"-",assign:"="},paramStrOperationsDelim:";"}}]);